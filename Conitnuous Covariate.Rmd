---
title: "Continuous Covariate"
author: "Soumyabrata Kundu"
date: '2024-11-25'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
library(TNDsen)
library(nnet)
library(ggplot2)
library(knitrProgressBar)
```




```{r}
# Simulation parameters
n = 10000
d = 1
beta0 = rnorm(4)
beta = matrix(rnorm(4*d, mean=1), ncol = d)

delta = runif(n,0.1, 0.5)
gamma = runif(n, 1, 5)
COR_range = c(0.1, 0.5)

# Data Generation
## Simulate Covariates
C = matrix(runif(n*d), ncol = d)

## o = softmax(beta @ C + beta_0)
softmax <- function(x) {
  # Subtract the maximum value from each element to prevent overflow
  exp_x <- exp(x - max(x))
  return( exp_x / sum(exp_x))
}

o = t(apply(beta %*%t(C) + beta0, 2, softmax))

## Data Generation Y,Z|C,T = 1 ~ Multinomial(o)
sample_class <- function(prob_vector) {
  sample(0:(length(prob_vector)-1), size = 1, prob = prob_vector)
}

class_labels = apply(o, 1, sample_class)
data = data.frame(
  Z = class_labels %% 2,
  Y = class_labels %/% 2,
  Label = as.factor(class_labels),
  C
)



## Sensitivity Parameters
l = pmax(o/(delta*gamma + (1-delta)), (o-delta)/(1-delta))          # l_zy
u = pmin(o*gamma/(delta + (1-delta)*gamma), 1)                      # u_zy
a = matrix(0, nrow = n, ncol = 4)                                   # p_zy | U = 0
pb = progress_estimated(n)


## Causal Odds ratio :
## Sample until COR in COR_range and Gamma in gamma_range
for(i in 1:n)
{
  stopping = 0
  while (TRUE) 
  {
    candidate = extraDistr::rdirichlet(1,c(1,1,1,1)) * (u[i,]-l[i,]) + l[i,]
    stopping = stopping + 1
    if(COR_range[1] <= odds.ratio(candidate) & odds.ratio(candidate) <= COR_range[2])
    {
      a[i,] = c(candidate)
      break
    }
    if(stopping == 10000) stop("This configuration does not work.")
  }
  update_progress(pb)
}

b = (o - a*(1-delta))/delta                                         # p_zy | U = 1
data$delta = delta                                                  # o = a * (1-delta) + b * delta
data$gamma =  pmax(apply(a/b, 1, max), apply(b/a, 1, max))          # max(a/b, b/a)
data$xi = pmax(apply(a, 1, odds.ratio) / apply(b, 1, odds.ratio),   # max(OR(a)/OR(b), OR(b)/OR(a))
               apply(b, 1, odds.ratio) / apply(a, 1, odds.ratio))

data
barplot(table(data$Label))
```



```{r}
result = TND_causal_bounds_from_data(2*Y + Z ~ C, data,  alpha = 0.90, conf.type='normal')
result$COR = apply(a,1,odds.ratio)
head(result)
```




```{r}
## Confidence Interval for Odds ratio
model = multinom(2*Y + Z ~ C, data=data, trace=FALSE)

o.hat = predict(model, type = "probs")       # predicted probabilities
Sigma_beta = vcov(model)                     # variance-covariance matrix
design_matrix = model.matrix(model)          # design matrix

for (i in 1:n) 
{
  Sigma_or = kronecker(c(-1,-1,1), design_matrix[i,]) * odds.ratio(o.hat[i,])  # 1 x 3d
  variance = diag(t(Sigma_or) %*% Sigma_beta %*% Sigma_or)                     # 1 x 1
  result$CI.lower[i] = odds.ratio(o.hat[i,]) - 1.645 * sqrt(variance)
  result$CI.upper[i] = odds.ratio(o.hat[i,]) + 1.645 * sqrt(variance)
}
```


```{r}
subsets = (1:10)
indices = subsets#[order(result$COR[subsets])]

ggplot(data = (1-result[indices,])*100, aes(y=1:length(indices)))+
  geom_segment(aes(x=lower.bound, xend = upper.bound, yend=1:length(indices)), color='red') + # COR
  geom_segment(aes(x=CI.lower, xend = CI.upper, y=1:length(indices)+0.2, yend=1:length(indices)+0.2), color='black') +
  
  geom_point(aes(x=COR), color='blue') + 
  geom_point(aes(x=upper.bound), color='red') +
  geom_point(aes(x=lower.bound), color='red') +
  geom_point(aes(x=CI.lower, y=1:length(indices)+0.2), color='black') +
  geom_point(aes(x=CI.upper, y=1:length(indices)+0.2), color='black') +
  geom_point(aes(x = (1-apply(o.hat[indices, ],1, odds.ratio))*100, , y=1:length(indices)+0.2), color='green')+
  xlim(c(0,100))
```



